<!doctype html>
<html lang="sk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Splachovanie - Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- Farebn√° Sch√©ma (Jedna modr√° ≈°k√°la) --- */
        :root {
            --color-blue-dark: #2563eb; /* Tmav≈°ia Modr√° (Hlavn√Ω akcent) */
            --color-blue-light: #3b82f6; /* Svetlej≈°ia Modr√° (Hover)*/
            --color-text-dark: #1f2937;
            --color-text-light: #6b7280;
            --color-bg: #f9fafb;
            --color-card: #ffffff;
            --color-border: #e5e7eb;
        }

        body { 
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 30px; 
            background-color: var(--color-bg);
            color: var(--color-text-dark);
        }
        
        /* Kontajner a hlaviƒçka */
        header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            margin-bottom: 30px; 
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 15px;
        }
        h1 { 
            font-size: 2rem; 
            margin: 0; 
            color: var(--color-blue-dark); 
            font-weight: 700;
        }
        h3 {
            font-size: 1.25rem;
            color: var(--color-text-dark);
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* Karty */
        .card { 
            background: var(--color-card); 
            border-radius: 8px; 
            padding: 25px; 
            margin-bottom: 25px; 
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05); 
            border: 1px solid var(--color-border);
        }
        
        /* Tlaƒçidl√° a Formul√°re (Zjednoten√© modr√© akcenty) */
        button, input[type="date"] {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid var(--color-border);
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--color-text-dark);
            background-color: var(--color-card);
        }
        
        /* V≈°etky akt√≠vne/prim√°rne buttony pou≈æ√≠vaj√∫ modr√∫ */
        .btn-filter.active, .btn-primary { 
            background: var(--color-blue-dark);
            color: white; 
            border-color: var(--color-blue-dark); 
            font-weight: 600;
        }
        .btn-filter.active:hover, .btn-primary:hover { 
            background: var(--color-blue-light); 
            border-color: var(--color-blue-light);
        }
        
        /* Filtre Rozlo≈æenie */
        .filter-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between; }
        .date-inputs { display: flex; gap: 15px; align-items: center; }
        .date-inputs label { font-size: 0.9rem; font-weight: 500; color: var(--color-text-light); }
        .quick-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        /* ≈†tatistiky */
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 20px; 
            margin-bottom: 25px;
        }
        .stat { 
            padding: 20px; 
            border-radius: 8px; 
            background: var(--color-card);
            border-left: 3px solid var(--color-blue-dark); /* Modr√Ω akcent na metrik√°ch */
        }
        .stat .label { 
            font-size: 0.85rem; 
            color: var(--color-text-light); 
            margin-bottom: 5px;
            font-weight: 500;
        }
        .stat .value {
            font-size: 2.2rem; 
            font-weight: 700;
            color: var(--color-text-dark);
        }
        
        /* Tabuƒæka */
        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            font-size: 0.9rem;
        }
        th, td { 
            padding: 12px 15px; 
            text-align: left;
        }
        th {
            background-color: #f3f4f6;
            color: var(--color-text-light);
            font-weight: 600;
            border-bottom: 2px solid var(--color-border);
        }
        td {
            border-bottom: 1px solid var(--color-border);
        }
        tbody tr:hover {
            background-color: #f8fafb;
        }

        /* Responz√≠vny dizajn */
        @media (max-width: 768px) {
            body { padding: 15px; }
            h1 { font-size: 1.5rem; }
            .filter-row { flex-direction: column; align-items: stretch; }
            .date-inputs { flex-direction: column; align-items: stretch; gap: 10px; }
            .quick-actions { justify-content: space-between; }
            .quick-actions button { flex-grow: 1; }
            .stat .value { font-size: 1.8rem; }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        .loader-text {
            animation: pulse 1.5s infinite ease-in-out;
            font-weight: 500;
            font-style: italic;
        }

        /* ≈†t√Ωl pre hodnoty, ktor√© sa pr√°ve naƒç√≠tavaj√∫ */
        .loading-val {
            color: var(--color-border) !important;
        }

        td {
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap; /* Zabr√°ni zalomeniu d√°tumu a ƒçasu */
        }
    </style>
</head>
<body>
    <header>
        <h1>üíß Splachovanie - Dashboard</h1>
        <div id="lastUpdate" class="small"></div>
    </header>

    <div class="card filters">
        <div class="filter-row">
            <div class="quick-actions">
                <button class="btn-filter" onclick="setQuickFilter(7, this)">7 dn√≠</button>
                <button class="btn-filter" onclick="setQuickFilter(30, this)">Mesiac</button>
                <button class="btn-filter" onclick="setQuickFilter(90, this)">3 mes.</button>
                <button class="btn-filter active" onclick="resetFilters(this)">V≈°etko</button>
            </div>
        </div>
        <div style="height: 1px; background: var(--color-border); margin: 15px 0;"></div>
        <div class="filter-row">
            <div class="date-inputs">
                <label>D√°tum od: <input type="date" id="dateFrom"></label>
                <label>D√°tum do: <input type="date" id="dateTo"></label>
            </div>
            <button class="btn-primary" onclick="applyDateFilter()">Pou≈æi≈• filter</button>
        </div>
    </div>

    <div class="stats">
        <div class="stat">
            <div class="label">Mal√© spl√°chnutia (3L)</div>
            <div id="countMale" class="value">0</div>
        </div>
        <div class="stat">
            <div class="label">Veƒæk√© spl√°chnutia (6L)</div>
            <div id="countVelke" class="value">0</div>
        </div>
        <div class="stat">
            <div class="label">Celkom spl√°chnut√≠</div>
            <div id="countTotal" class="value">0</div>
        </div>
        <div class="stat">
            <div class="label">Celkov√° spotreba</div>
            <div id="totalLiters" class="value">0 L</div>
        </div>
    </div>

    <div class="card">
        <h3>Prehƒæad spotreby podƒæa dn√≠</h3>
        <div class="chart-container" style="height: 350px;"> 
            <canvas id="chart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>Posledn√© z√°znamy (Max 200 zobrazen√Ωch)</h3>
        <div style="overflow:auto;max-height:400px">
            <table id="dataTable">
                <thead><tr><th>D√°tum</th><th>ƒåas</th><th>Typ</th><th>Objem (L)</th></tr></thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="4" style="text-align:center; padding: 40px; color: var(--color-text-light);">
                            <div class="loader-text">Naƒç√≠tavam d√°ta z Google Sheets...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    
    <script>
        const SHEET_ID = "10SkH1lLlO-pF1v_WwDpeD_XJLNLAoFEglbJS7TIZY5A";
        const SHEET_GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

        const OBJEM_MALE = 3;
        const OBJEM_VELKE = 6;
        let chart;
        let allFetchedRows = [];

        function parseGViz(text) {
            const jsonText = text.replace(/^[\s\S]*?setResponse\(|\);?\s*$/g, '');
            return JSON.parse(jsonText);
        }

        // Jednoduch√© mapovanie typu
        function normalizeType(type) {
            type = String(type || '').toLowerCase().trim();
            return type.includes("mal") || type === "m" ? "male" : "velke";
        }

        function volumeFor(type) {
            return type === "male" ? OBJEM_MALE : OBJEM_VELKE;
        }

        // Jednoduch√© parseDateSafe len pre GViz Date() alebo Date objekt
        function parseDateSafe(d) {
            if (!d) return null;
            if (d instanceof Date) return d;
            if (typeof d === "string") {
                if (d.startsWith("Date(")) {
                    const nums = d.match(/\d+/g);
                    // Mesiac v JS Date je 0-11, gviz to posiela rovnako
                    if (nums && nums.length >= 3) return new Date(nums[0], nums[1], nums[2]);
                }
                const isoDate = new Date(d);
                if (!isNaN(isoDate)) return isoDate;
            }
            return null;
        }

        // Roztriedenie a naplnenie grafu podƒæa d√°tumov
        function aggregateByDate(rows) {
            const agg = {};
            
            // 1. Zisti rozsah d√°tumov z filtrov
            let start = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value) : null;
            let end = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value) : null;

            // Ak filtre nie s√∫ nastaven√©, zober prv√Ω a posledn√Ω d√°tum z d√°t
            if (!start || !end) {
                const dates = rows.map(r => parseDateSafe(r[0])).filter(d => d);
                if (dates.length > 0) {
                    start = new Date(Math.min(...dates));
                    end = new Date(Math.max(...dates));
                }
            }

            // 2. Predvypl≈à "agg" objekt v≈°etk√Ωmi d≈àami v rozsahu (nastav nuly)
            if (start && end) {
                let curr = new Date(start);
                while (curr <= end) {
                    const key = curr.toISOString().slice(0, 10);
                    agg[key] = { male: 0, velke: 0, total: 0 };
                    curr.setDate(curr.getDate() + 1);
                }
            }

            // 3. Napl≈à objekt re√°lnymi d√°tami (tak ako doteraz)
            rows.forEach(r => {
                const d = parseDateSafe(r[0]);
                if (!d) return;
                const key = d.toISOString().slice(0, 10);
                const type = normalizeType(r[2]);
                const liters = volumeFor(type);

                // Ak by n√°hodou kƒæ√∫ƒç neexistoval (mimo rozsahu), vytvor ho
                if (!agg[key]) agg[key] = { male: 0, velke: 0, total: 0 };
                
                agg[key][type]++;
                agg[key].total += liters;
            });
            // Vytvpr√≠ polia pre typy splachnuti a litre
            const keys = Object.keys(agg).sort();
            return {
                labels: keys,
                male: keys.map(k => agg[k].male),
                velke: keys.map(k => agg[k].velke),
                total: keys.map(k => agg[k].total)
            };
        }

        // Vykreslenie grafu
        function renderChart(labels, maleData, velkeData) {
            const ctx = document.getElementById('chart').getContext('2d');
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type:'bar',
                data:{
                    labels: labels,
                    datasets:[
                        { label:'Mal√© (3L)', data:maleData, backgroundColor:'rgba(37,99,235,0.9)', borderRadius:4 },
                        { label:'Veƒæk√© (6L)', data:velkeData, backgroundColor:'rgba(59,130,246,0.6)', borderRadius:4 }
                    ]
                },
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{ legend:{ position:'top', labels:{ boxWidth:10, color:'var(--color-text-light)' } } },
                    scales:{ x:{ stacked:true, grid:{ display:false } }, y:{ stacked:true, beginAtZero:true, grid:{ color:'#f3f4f6' } } }
                }
            });
        }

        // Naplnenie UI
        function populateUI(rows) {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';

            let countMale = 0, countVelke = 0, litersTotal = 0;
            const latestForTable = rows.slice().reverse().slice(0,200);

            latestForTable.forEach(r=>{
                const date = r[0] instanceof Date ? r[0].toLocaleDateString('sk-SK') : '';
                const time = r[1]||'';
                const typeOriginal = r[2]||'';
                const liters = volumeFor(normalizeType(typeOriginal));

                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${date}</td><td>${time}</td><td>${typeOriginal}</td><td>${liters}</td>`;
                tbody.appendChild(tr);
            });

            rows.forEach(r=>{
                const type = normalizeType(r[2]);
                const liters = volumeFor(type);
                if(type==='male') countMale++; else countVelke++;
                litersTotal += liters;
            });

            document.getElementById('countMale').textContent = countMale;
            document.getElementById('countVelke').textContent = countVelke;
            document.getElementById('countTotal').textContent = countMale + countVelke;
            document.getElementById('totalLiters').textContent = litersTotal.toFixed(1)+' L';

            const agg = aggregateByDate(rows);
            if(agg.labels.length>0) renderChart(agg.labels, agg.male, agg.velke);
        }

        // Quick filter
        function setQuickFilter(days, btn) {
            document.querySelectorAll('.quick-actions .btn-filter').forEach(b=>b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            const end = new Date(), start = new Date();
            start.setDate(end.getDate()-days);

            document.getElementById('dateFrom').value = start.toISOString().slice(0,10);
            document.getElementById('dateTo').value = end.toISOString().slice(0,10);

            applyDateFilter(true);
        }

        function resetFilters(btn) {
            document.querySelectorAll('.quick-actions .btn-filter').forEach(b=>b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            populateUI(allFetchedRows);
        }

        function applyDateFilter(isQuick=false) {
            const fromVal = document.getElementById('dateFrom').value;
            const toVal = document.getElementById('dateTo').value;

            if(!isQuick && (fromVal||toVal)) {
                document.querySelectorAll('.quick-actions .btn-filter').forEach(b=>b.classList.remove('active'));
            }

            if(!fromVal && !toVal) {
                populateUI(allFetchedRows);
                return;
            }

            const fromDate = fromVal ? new Date(fromVal) : new Date('2000-01-01');
            fromDate.setHours(0,0,0,0);
            const toDate = toVal ? new Date(toVal) : new Date();
            toDate.setHours(23,59,59,999);

            const filteredRows = allFetchedRows.filter(r=>{
                const d = parseDateSafe(r[0]);
                if(!d) return false;
                d.setHours(12,0,0,0); // porovn√°vame len de≈à
                return d>=fromDate && d<=toDate;
            });

            populateUI(filteredRows);
        }

        // Naƒç√≠tanie d√°t
        async function updateAll() {
            // 1. Zobrazenie stavu naƒç√≠tavania v ≈°tatistik√°ch (voliteƒæn√©)
            const statsIds = ['countMale', 'countVelke', 'countTotal', 'totalLiters'];
            if (allFetchedRows.length === 0) {
                statsIds.forEach(id => document.getElementById(id).textContent = "--");
            }

            try {
                const resp = await fetch(SHEET_GVIZ_URL);
                if (!resp.ok) throw new Error('Nepodarilo sa stiahnu≈• d√°ta');
                
                const text = await resp.text();

                // 2. BEZPEƒåNEJ≈†√ç PARSING: Namiesto replace hƒæad√°me prv√∫ "{" a posledn√∫ "}"
                const startIdx = text.indexOf('{');
                const endIdx = text.lastIndexOf('}') + 1;
                
                if (startIdx === -1 || endIdx === 0) {
                    throw new Error('Neplatn√Ω form√°t d√°t z Google Sheets');
                }
                
                const jsonText = text.substring(startIdx, endIdx);
                const gv = JSON.parse(jsonText);

                // 3. SPRACOVANIE RIADKOV
                allFetchedRows = (gv.table.rows || []).map(r => {
                    // Bezpeƒçn√© vytiahnutie hodn√¥t z buniek (c[0], c[1], c[2])
                    const cellDate = r.c[0] ? r.c[0].v : null;
                    const cellTime = r.c[1] ? r.c[1].v : '';
                    const cellType = r.c[2] ? r.c[2].v : '';
                    
                    return [
                        parseDateSafe(cellDate), 
                        cellTime, 
                        cellType
                    ];
                });

                // 4. AKTUALIZ√ÅCIA UI (Filtre a Tabuƒæka)
                const activeQuick = document.querySelector('.quick-actions .active');
                const fromVal = document.getElementById('dateFrom').value;
                const toVal = document.getElementById('dateTo').value;

                if (activeQuick || fromVal || toVal) {
                    applyDateFilter(!!activeQuick);
                } else {
                    // Ak nie s√∫ filtre, zobraz v≈°etko a nastav tlaƒçidlo "V≈°etko" ako akt√≠vne
                    const btnVsetko = document.querySelector('.quick-actions button:last-child');
                    resetFilters(btnVsetko);
                }

                // 5. ƒåAS POSLEDNEJ AKTUALIZ√ÅCIE
                const now = new Date();
                document.getElementById('lastUpdate').textContent = 
                    `Aktualizovan√©: ${now.toLocaleTimeString('sk-SK', {hour:'2-digit', minute:'2-digit'})}`;

            } catch (err) {
                console.error('Chyba v updateAll:', err);
                document.getElementById('lastUpdate').textContent = "Chyba naƒç√≠tania!";
                
                // Ak nastane chyba, vyp√≠≈°eme ju aj do tabuƒæky pre lep≈°iu diagnostiku
                const tbody = document.querySelector('#dataTable tbody');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">
                        Chyba: ${err.message}. Skontrolujte konzolu (F12).
                    </td></tr>`;
                }
            }
        }

        updateAll();
        setInterval(updateAll,30000);
    </script>
</body>
</html>