<!doctype html>
<html lang="sk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Splachovanie</title>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
            margin: 12px;
            padding: 0;
            color: #111
        }

        header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px
        }

        h1 {
            font-size: 1.1rem;
            margin: 0
        }

        .card {
            background: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03)
        }

        .stats {
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }

        .stat {
            flex: 1;
            min-width: 140px;
            padding: 8px;
            border-radius: 6px;
            background: #f8f9fb
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem
        }

        th, td {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
            text-align: left
        }

        @media (max-width:600px) {
            .stats {
                flex-direction: column
            }
        }

        .small {
            font-size: 0.85rem;
            color: #666
        }

        #lastUpdate {
            font-size: 0.85rem;
            color: #666;
            margin-top: 6px
        }
    </style>
</head>
<body>
    <header>
        <h1>Splachovanie - live prehľad</h1>
    </header>

    <div class="card stats">
        <div class="stat">
            <div class="small">Malé spláchnutia</div>
            <div id="countMale" style="font-size:1.6rem">0</div>
        </div>
        <div class="stat">
            <div class="small">Veľké spláchnutia</div>
            <div id="countVelke" style="font-size:1.6rem">0</div>
        </div>
        <div class="stat">
            <div class="small">Celková spotreba</div>
            <div id="totalLiters" style="font-size:1.6rem">0 L</div>
        </div>
    </div>

    <div class="card">
        <canvas id="chart"></canvas>
        <div id="lastUpdate" class="small"></div>
    </div>

    <div class="card">
        <h3>Posledné záznamy</h3>
        <div style="overflow:auto;max-height:360px">
            <table id="dataTable">
                <thead><tr><th>Dátum</th><th>Čas</th><th>Typ</th><th>Objem (L)</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const SHEET_ID = "10SkH1lLlO-pF1v_WwDpeD_XJLNLAoFEglbJS7TIZY5A";
        const SHEET_GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

        const OBJEM_MALE = 3;
        const OBJEM_VELKE = 6;

        let chart;

        function parseGViz(text) {
            const jsonText = text.replace(/^[\s\S]*?setResponse\(|\);?\s*$/g, '');
            return JSON.parse(jsonText);
        }

        async function fetchSheet() {
            const resp = await fetch(SHEET_GVIZ_URL);
            const text = await resp.text();
            const gv = parseGViz(text);

            const rows = (gv.table.rows || []).map(r => r.c.map(cell => cell && typeof cell.v !== 'undefined' ? cell.v : ""));
            return rows;
        }

        function normalizeType(type) {
            if (!type) return '';
            type = type.toLowerCase().trim();
            if (type === "male" || type === "malé") return "male";
            if (type === "velke" || type === "veľké") return "velke";
            return '';
        }

        function volumeFor(type) {
            if (!type) return 0;
            if (type === "male") return OBJEM_MALE;
            if (type === "velke") return OBJEM_VELKE;
            return 0;
        }

        function aggregateByDate(rows) {
            const agg = {};

            rows.forEach(r => {
                const date = r[0] || 'unknown';   
                const type = normalizeType(r[2]); 
                const liters = volumeFor(type);

                if (!agg[date]) agg[date] = { male: 0, velke: 0, total: 0 };

                if (type === "male") { 
                    agg[date].male++; 
                    agg[date].total += liters; 
                } else if (type === "velke") { 
                    agg[date].velke++; 
                    agg[date].total += liters; 
                }
            });

            const keys = Object.keys(agg).sort((a, b) => new Date(a) - new Date(b));
            const labels = keys;
            const male = keys.map(k => agg[k].male);
            const velke = keys.map(k => agg[k].velke);
            const total = keys.map(k => agg[k].total);

            return { labels, male, velke, total };
        }

        function renderChart(labels, maleData, velkeData) {
            const ctx = document.getElementById('chart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Malé', data: maleData, backgroundColor: '#4BC0C0' },
                        { label: 'Veľké', data: velkeData, backgroundColor: '#FF9F40' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
                }
            });
        }

        function populateUI(rows) {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';

            let countMale = 0, countVelke = 0, litersTotal = 0;

            // Pre tabuľku zobrazíme len posledných 200
            const latest = rows.slice().reverse().slice(0, 200);
            latest.forEach(r => {
                const date = r[0] || '';
                const time = r[1] || '';
                const typeOriginal = r[2] || '';
                const type = normalizeType(typeOriginal);
                const liters = volumeFor(type);

                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${date}</td><td>${time}</td><td>${typeOriginal}</td><td>${liters}</td>`;
                tbody.appendChild(tr);
            });

            // Pre stats spočítame všetky záznamy
            rows.forEach(r => {
                const type = normalizeType(r[2]);
                const liters = volumeFor(type);

                if (type === "male") countMale++;
                else if (type === "velke") countVelke++;

                litersTotal += liters;
            });

            document.getElementById('countMale').textContent = countMale;
            document.getElementById('countVelke').textContent = countVelke;
            document.getElementById('totalLiters').textContent = litersTotal + ' L';

            const agg = aggregateByDate(rows);
            renderChart(agg.labels, agg.male, agg.velke);

            const now = new Date();
            document.getElementById('lastUpdate').textContent = `Aktualizované: ${now.toLocaleString()}`;
        }


        async function updateAll() {
            try {
                const rows = await fetchSheet();
                populateUI(rows);
            } catch (err) {
                console.error("Chyba pri načítaní dát:", err);
                document.getElementById('lastUpdate').textContent = "Chyba pri načítaní dát (skontroluj, či je sheet verejný).";
            }
        }

        updateAll();
        setInterval(updateAll, 30000);
    </script>
</body>
</html>

